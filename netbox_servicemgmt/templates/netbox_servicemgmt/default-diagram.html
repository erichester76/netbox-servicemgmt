{% extends 'generic/object.html' %}
{% load buttons %}
{% load helpers %}
{% load plugins %}

{% block content %}
<style>
    .toolbar {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
}

.toolbar .btn {
  margin-right: 10px;
}

.dropdown-menu {
  max-height: 200px;
  overflow-y: auto;
}
</style>
<div class="toolbar">
    <button id="toggle-layout" class="btn btn-primary">Toggle Layout (Vertical/Horizontal)</button>
    <div class="dropdown">
      <button id="toggle-object-types" class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown">
        Hide Object Types
      </button>
      <div class="dropdown-menu" id="object-type-menu">
        <!-- Object types will be populated dynamically -->
      </div>
    </div>
  </div>
  
<div class="tab-content">
    <div class="tab-pane active">
        <div class="card mt-3">
            <h5 class="card-header">Diagram</h5>
            <div class="card-body">
                <pre id="mermaid-diagram" class="mermaid">
                    {{ mermaid_source|safe }}
                </pre>
            </div>
        </div>
    </div>
</div>

<!-- <div class="tab-content">
    <div class="tab-pane active">
        <div class="card mt-3">
            <h5 class="card-header">Diagram</h5>
            <div class="card-body">
                <div>
                <pre>
                   mermaid_source|safe
                </pre>
                </div>
            </div>
        </div>
    </div>
</div>  -->

<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
  let currentLayout = "LR"; // Initial layout direction
  const mermaidContainer = document.getElementById("mermaid-diagram");
  const objectTypes = {}; // Object types and their visibility states

  // Parse object types from the original Mermaid code
  function initializeObjectTypes() {
    const regex = /^([a-z]+)_\d+/g; 
    const matches = [...originalMermaidCode.matchAll(regex)];
    console.log(matches)
    matches.forEach(match => {
      const objType = match[1];
      if (!objectTypes.hasOwnProperty(objType)) {
        objectTypes[objType] = true; // Initially visible
        addObjectTypeToMenu(objType);
      }
    });
  }

  // Add object types to the dropdown menu
  function addObjectTypeToMenu(objType) {
    console.log("adding object "+objType)
    const menu = document.getElementById("object-type-menu");
    const item = document.createElement("div");
    item.className = "dropdown-item";
    item.innerHTML = `
      <input type="checkbox" id="toggle-${objType}" checked>
      <label for="toggle-${objType}">${objType}</label>
    `;
    menu.appendChild(item);

    // Add event listener for toggling visibility
    const checkbox = item.querySelector("input");
    checkbox.addEventListener("change", () => {
      objectTypes[objType] = checkbox.checked;
      updateMermaidCode();
    });
  }

  // Update the Mermaid code and re-render the diagram
  function updateMermaidCode() {
    let updatedCode = originalMermaidCode.replace(
      /graph (LR|TD)/,
      `graph ${currentLayout}`
    );

    // Remove hidden object types and their links
    Object.keys(objectTypes).forEach(objType => {
      if (!objectTypes[objType]) {
        const regexNode = new RegExp(`\\b${objType}_\\d+\\[.*?\\]\\n`, "g");
        const regexLink = new RegExp(
          `.*?(\\b${objType}_\\d+|\\b_\\d+${objType})\\s.*\\n`,
          "g"
        );
        updatedCode = updatedCode.replace(regexNode, "").replace(regexLink, "");
      }
    });
    mermaidContainer.innerText = updatedCode // Update the container with new code
    mermaid.run({
        suppressErrors: false,
        nodes: [document.getElementById('mermaid-diagram')]
    });    
  }


  // Event listener for toggling layout
  document.getElementById("toggle-layout").addEventListener("click", () => {
    currentLayout = currentLayout === "LR" ? "TD" : "LR";
    updateMermaidCode();
  });

  // Initialize object types and render the initial diagram
  initializeObjectTypes();
  mermaid.initialize({ startOnLoad: true });
});

</script>
{% endblock %}