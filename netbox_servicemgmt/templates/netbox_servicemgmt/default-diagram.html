{% extends 'generic/object.html' %}
{% load buttons %}
{% load helpers %}
{% load plugins %}

{% block content %}
<style>
.toolbar {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
}
.toolbar .btn {
  margin-right: 10px;
}
.dropdown-menu {
  max-height: 200px;
  overflow-y: auto;
}
</style>
<div class="toolbar">
  <button id="toggle-layout" class="btn btn-primary">Toggle Layout (Vertical/Horizontal)</button>
  <div class="dropdown">
    <button id="toggle-object-types" class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown">
      Hide Object Types
    </button>
    <div class="dropdown-menu" id="object-type-menu">
      <!-- Object types will be populated dynamically -->
    </div>
  </div>
</div>

<div class="tab-content">
  <div class="tab-pane active">
    <div class="card mt-3">
      <h5 class="card-header">Diagram</h5>
      <div class="card-body">
        <div id="mermaid-container">
          <div id="mermaid-diagram" class="mermaid">
            {{ mermaid_source|safe }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/mermaid@9/dist/mermaid.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  let currentLayout = "LR"; // Initial layout direction
  const originalMermaidCode = document.getElementById('mermaid-diagram').innerText.trim();
  const objectTypes = {}; // Object types and their visibility states

  // Parse object types from the original Mermaid code
  function initializeObjectTypes() {
    const regex = /^.+([a-z]+)_\d+/g; 
    const matches = new Set([...originalMermaidCode.matchAll(regex)].map(match => match[1]));
    matches.forEach(objType => {
      console.log(objType)
      objectTypes[objType] = true;
      addObjectTypeToMenu(objType);
    });

  }

  // Add object types to the dropdown menu
  function addObjectTypeToMenu(objType) {
    const menu = document.getElementById("object-type-menu");
    const item = document.createElement("div");
    item.className = "dropdown-item";
    item.innerHTML = `
      <input type="checkbox" id="toggle-${objType}" checked>
      <label for="toggle-${objType}">${objType}</label>
    `;
    menu.appendChild(item);

    // Add event listener for toggling visibility
    const checkbox = item.querySelector("input");
    checkbox.addEventListener("change", () => {
      objectTypes[objType] = checkbox.checked;
      updateMermaidCode();
    });
  }

  // Update the Mermaid code and re-render the diagram
  function updateMermaidCode() {
    let updatedCode = originalMermaidCode.replace(/graph (LR|TD)/, `graph ${currentLayout}`);
     // Modify object types based on visibility
    Object.keys(objectTypes).forEach(objType => {
      if (!objectTypes[objType]) {
        // Prepend `#` to hide lines related to the object type
        updatedCode = updatedCode.replace(new RegExp(`^.+(${objType})`, "gm"), "#$1")      
    } else {
        // Remove leading `#` to show lines related to the object type
        updatedCode = updatedCode.replace(new RegExp(`^.+#${objType}`, "gm"), "$1");
    }
  });


    // Update the container with new code by first deleting it to clear any mermaid objects
    const mermaidContainer = document.getElementById('mermaid-container');
    const mermaidDiagram = document.getElementById('mermaid-diagram');
    if (mermaidDiagram) {
      mermaidContainer.removeChild(mermaidDiagram);
    }
    const newDiagram = document.createElement('div');
    newDiagram.id = 'mermaid-diagram';
    newDiagram.className = 'mermaid';
    newDiagram.innerText = updatedCode;
    mermaidContainer.appendChild(newDiagram);
    mermaid.init(undefined, newDiagram);
  }

  // Event listener for toggling layout
  document.getElementById("toggle-layout").addEventListener("click", () => {
    currentLayout = currentLayout === "LR" ? "TD" : "LR";
    updateMermaidCode();
  });

  // Initialize Mermaid and object types
  initializeObjectTypes();
  mermaid.init();
});
</script>
{% endblock %}
