{% extends 'generic/_base.html' %}
{% load i18n %}

{% block title %}
  {% if object.pk %}
    {% trans "Editing" %} {{ object|meta:"verbose_name" }} {{ object }}
  {% else %}
    {% blocktrans trimmed with object_type=object|meta:"verbose_name" %}
      Add a new {{ object_type }}
    {% endblocktrans %}
  {% endif %}
{% endblock title %}

{% block controls %}
  <div class="btn-list">
    {% if settings.DOCS_ROOT and object.docs_url %}
      <a href="{{ object.docs_url }}" target="_blank" class="btn btn-outline-secondary" title="{% trans "View model documentation" %}">
        <i class="mdi mdi-help-circle"></i> {% trans "Help" %}
      </a>
    {% endif %}
  </div>
{% endblock controls %}

{% block tabs %}
  <ul class="nav nav-tabs">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="edit-form-tab" data-bs-toggle="tab" data-bs-target="#edit-form" type="button" role="tab" aria-controls="edit-form" aria-selected="true">
        {% if object.pk %}{% trans "Edit" %}{% else %}{% trans "Create" %}{% endif %}
      </button>
    </li>
  </ul>
{% endblock tabs %}

{% block content %}
  <div class="tab-pane show active" id="edit-form" role="tabpanel" aria-labelledby="object-list-tab">

    {# Warn about missing prerequisite objects #}
    {% if prerequisite_model %}
      {% include 'inc/missing_prerequisites.html' %}
    {% endif %}

    <form action="" method="post" enctype="multipart/form-data" class="object-edit mt-5">
      {% csrf_token %}
      
      {# Include the standard form rendering using NetBox's layout #}
      <div id="form_fields" hx-disinherit="hx-select hx-swap">
        {% block form %}
          {% include 'htmx/form.html' %}
        {% endblock form %}
      </div>

      {# Add Requirement Button #}
      <div class="my-3">
        <button id="add-requirement-button" class="btn btn-secondary">{% trans "Add Requirement" %}</button>
      </div>

      <div class="btn-float-group-right">
        {% block buttons %}
          <a href="{{ return_url }}" class="btn btn-outline-secondary btn-float">{% trans "Cancel" %}</a>
          {% if object.pk %}
            <button type="submit" name="_update" class="btn btn-primary">{% trans "Save" %}</button>
          {% else %}
            <div class="btn-group" role="group" aria-label="{% trans "Actions" %}">
              <button type="submit" name="_create" class="btn btn-primary">{% trans "Create" %}</button>
              <button type="submit" name="_addanother" class="btn btn-outline-primary btn-float">{% trans "Create & Add Another" %}</button>
            </div>
          {% endif %}
        {% endblock buttons %}
      </div>
    </form>
  </div>

  {# Include your custom JavaScript here for dynamic behavior #}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        let currentRequirement = 1;

        function hideUnusedRequirements() {
            for (let i = currentRequirement + 1; i <= 20; i++) {
                let field = document.getElementById(`id_requirement${i}_field`);
                let value = document.getElementById(`id_requirement${i}_value`);
                if (field && value) {
                    field.parentElement.style.display = 'none';
                    value.parentElement.style.display = 'none';
                }
            }
        }

        function showNextRequirement() {
            currentRequirement += 1;
            if (currentRequirement <= 20) {
                let field = document.getElementById(`id_requirement${currentRequirement}_field`);
                let value = document.getElementById(`id_requirement${currentRequirement}_value`);
                if (field && value) {
                    field.parentElement.style.display = 'block';
                    value.parentElement.style.display = 'block';
                }
            }
        }

        // Hide unused requirement fields initially
        hideUnusedRequirements();

        // Event listener for "Add Requirement" button
        document.getElementById('add-requirement-button').addEventListener('click', function (e) {
            e.preventDefault();
            showNextRequirement();
        });

          // SLO Selection Behavior
          document.getElementById('id_service_slo').addEventListener('change', function () {
            const sloId = this.value;
            if (sloId) {
                fetch(`/plugins/netbox_servicemgmt/api/slo-details/${sloId}/`)
                    .then(response => response.json())
                    .then(data => {
                        // Update form fields with the SLO override values
                        document.getElementById('id_vip_required').checked = data.vip_required;
                        document.getElementById('id_primary_site').value = data.primary_site;
                        document.getElementById('id_secondary_site').value = data.secondary_site;
                        document.getElementById('id_tertiary_site').value = data.tertiary_site;
                        document.getElementById('id_instances_per_site').value = data.instances_per_site;
                        // Continue for other fields...
                    });
            }
        });

        // Load field options dynamically based on selected object_type
        document.getElementById('id_object_type').addEventListener('change', function () {
            const objectType = this.value;
            if (objectType) {
                fetch(`/plugins/netbox_servicemgmt/api/object-fields/${objectType}/`)
                    .then(response => response.json())
                    .then(data => {
                        for (let i = 1; i <= currentRequirement; i++) {
                            const fieldSelect = document.getElementById(`id_requirement${i}_field`);
                            fieldSelect.innerHTML = '';  // Clear current options
                            data.fields.forEach(field => {
                                const option = document.createElement('option');
                                option.value = field.name;
                                option.text = field.verbose_name;
                                fieldSelect.add(option);
                            });
                        }
                    });
            }
        });
    });
  </script>
{% endblock content %}

{% block modals %}
  {% include 'inc/htmx_modal.html' with size='lg' %}
{% endblock %}
